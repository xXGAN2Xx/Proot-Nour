name: Build and Package
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      wrappers: ${{ steps.filter.outputs.wrappers }}
    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            wrappers:
              - 'wrappers/**'

  build:
    needs: detect
    if: needs.detect.outputs.wrappers == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # -------------------------
      # NEW: download external artifact and place its files into ./files
      # -------------------------
      - name: Download artifact (ID: 3774821538) and extract into ./files
        env:
          ARTIFACT_ID: "3774821538"
          OWNER: "xXGAN2Xx"
          REPO: "proot-nour"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p downloaded_artifact files

          echo "Requesting artifact $ARTIFACT_ID from $OWNER/$REPO..."
          # Use the REST API to download the artifact as a ZIP. The API redirects to a download URL; -L follows it.
          curl -sSL -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$OWNER/$REPO/actions/artifacts/$ARTIFACT_ID/zip" -o artifact.zip

          if [ ! -s artifact.zip ]; then
            echo "Warning: artifact.zip is empty or missing. Check artifact ID / permissions."
          else
            echo "Unzipping artifact.zip..."
            unzip -o artifact.zip -d downloaded_artifact
            echo "Copying artifact contents into ./files/"
            # unzip creates a top-level folder per artifact; copy its contents into ./files
            shopt -s dotglob || true
            cp -r downloaded_artifact/*/* ./files/ 2>/dev/null || cp -r downloaded_artifact/* ./files/ || true
            ls -la files || true
          fi

      - uses: gradle/wrapper-validation-action@v3

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Compile Kotlin Wrapper and produce server.kar
        working-directory: wrappers/Kotlin
        run: |
          set -euo pipefail

          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew shadowJar
          else
            echo "Error: gradlew not found in $(pwd)"
            ls -la
            exit 1
          fi

          # Find a sensible jar name (prefer -all or -shadow)
          JAR=$(ls -1 build/libs/*.jar 2>/dev/null | grep -E '\-all\.jar$|\-shadow\.jar$' || true)
          if [ -z "$JAR" ]; then
            JAR=$(ls -1 build/libs/*.jar 2>/dev/null | head -n 1 || true)
          fi

          if [ -z "$JAR" ]; then
            echo "Error: no JAR found in build/libs/ after build!"
            echo "Contents of build/libs/:"
            ls -l build/libs/ || true
            exit 1
          fi

          echo "Found JAR: $JAR"
          cp "$JAR" server.jar
          cp server.jar server.kar
          echo "Produced wrappers/Kotlin/server.kar"

      - name: Upload Artifacts (includes downloaded files)
        uses: actions/upload-artifact@v4
        with:
          name: Artifacts
          path: |
            wrappers/Kotlin/server.kar
            files/**
          if-no-files-found: error
