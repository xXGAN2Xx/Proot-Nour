name: Build and commit server.jar

on:
  push:
    paths:
      - 'wrappers/Kotlin/**'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK (Temurin, latest patch for chosen major)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          # Use the current latest major (21) and check-latest ensures the newest patch is used
          java-version: '21'
          check-latest: true

      - name: Build (explicit main/nourd, then fallback)
        shell: bash
        run: |
          set -eo pipefail

          mkdir -p build
          BUILT_SERVER=false
          BUILT_SERVERD=false

          ensure_kotlinc() {
            if ! command -v kotlinc >/dev/null 2>&1; then
              echo "kotlinc not found â€” installing kotlin via sdkman..."
              curl -sS https://get.sdkman.io | bash
              # shellcheck disable=SC1090
              source "$HOME/.sdkman/bin/sdkman-init.sh"
              sdk install kotlin
            fi
          }

          # 1) Prefer explicit compilation of wrappers/Kotlin/main.kt -> build/server.jar
          if [ -f "wrappers/Kotlin/main.kt" ]; then
            ensure_kotlinc
            echo "Compiling wrappers/Kotlin/main.kt -> build/server.jar"
            kotlinc wrappers/Kotlin/main.kt -include-runtime -d build/server.jar
            if [ -f build/server.jar ]; then
              BUILT_SERVER=true
            fi
          fi

          # 2) Prefer explicit compilation of wrappers/Kotlin/*nourd*.kt -> build/serverd.jar
          NOURD_KT=$(find wrappers/Kotlin -maxdepth 1 -type f -iname "*nourd*.kt" | head -n 1 || true)
          if [ -n "$NOURD_KT" ]; then
            ensure_kotlinc
            echo "Compiling $NOURD_KT -> build/serverd.jar"
            kotlinc "$NOURD_KT" -include-runtime -d build/serverd.jar
            if [ -f build/serverd.jar ]; then
              BUILT_SERVERD=true
            fi
          fi

          # 3) Fallback: if no explicit compiled jars and gradlew exists, try Gradle build
          if [ "$BUILT_SERVER" = false ] && [ "$BUILT_SERVERD" = false ] && [ -x "./gradlew" ]; then
            echo "No explicit main/nourd compilation done. Running ./gradlew clean build (or assemble)."
            chmod +x ./gradlew
            ./gradlew clean build || ./gradlew clean assemble || true
            # try to pick jars produced by Gradle (first jar -> server.jar)
            JAR_FOUND=$(find . -type f -name "*.jar" ! -path "*/.gradle/*" ! -path "./build/*/tmp/*" | head -n 1 || true)
            if [ -n "$JAR_FOUND" ]; then
              mkdir -p build
              cp "$JAR_FOUND" build/server.jar
              BUILT_SERVER=true
            fi
          fi

          # 4) Last-resort fallback: compile all .kt files into build/server.jar (original behaviour)
          if [ "$BUILT_SERVER" = false ] && [ "$BUILT_SERVERD" = false ]; then
            echo "Falling back to compiling all Kotlin files into build/server.jar"
            # install kotlin if needed
            ensure_kotlinc
            KT_FILES=$(find wrappers -type f -name "*.kt" -print | tr '\n' ' ' || true)
            if [ -n "$KT_FILES" ]; then
              kotlinc $KT_FILES -include-runtime -d build/server.jar
              if [ -f build/server.jar ]; then
                BUILT_SERVER=true
              fi
            fi
          fi

          # Verify at least one jar was built
          if [ "$BUILT_SERVER" = false ] && [ "$BUILT_SERVERD" = false ]; then
            echo "ERROR: No jar built."
            exit 1
          fi

          # Copy built jars into the root directory with the desired names
          if [ "$BUILT_SERVER" = true ]; then
            cp -f build/server.jar ./server.jar
            echo "server.jar copied to the root directory"
          fi
          if [ "$BUILT_SERVERD" = true ]; then
            cp -f build/serverd.jar ./serverd.jar
            echo "serverd.jar copied to the root directory"
          fi

      - name: Commit and push built jars
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage any of the built jars that exist in the root
          if [ -f server.jar ]; then
            git add server.jar
          fi
          if [ -f serverd.jar ]; then
            git add serverd.jar
          fi

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update server jars from CI"
            git push origin HEAD:${GITHUB_REF_NAME}
          fi
