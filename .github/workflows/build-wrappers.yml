name: Build and commit jars

on:
  push:
    paths:
      - 'wrappers/Kotlin/**'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK (Temurin, latest patch for chosen major)
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'
          check-latest: true

      - name: Build dynamic server jars
        shell: bash
        run: |
          set -e

          # Function to install Kotlin if missing
          ensure_kotlinc() {
            if ! command -v kotlinc >/dev/null 2>&1; then
              echo "kotlinc not found â€” installing kotlin via sdkman..."
              curl -sS https://get.sdkman.io | bash
              source "$HOME/.sdkman/bin/sdkman-init.sh"
              sdk install kotlin
            fi
          }

          ensure_kotlinc

          # Flag to track if we actually built anything
          BUILT_ANY=false

          # 1. Find all files matching 'main*.kt' in wrappers/Kotlin
          # 2. Loop through them
          for file in wrappers/Kotlin/main*.kt; do
            # Check if file exists (handles case where glob returns nothing)
            if [ ! -f "$file" ]; then
              echo "No files matching wrappers/Kotlin/main*.kt found."
              break
            fi

            echo "Processing $file..."
            
            # Extract filename (e.g., "maind.kt" or "main.kt")
            filename=$(basename "$file")
            
            # Remove extension to get base (e.g., "maind" or "main")
            base="${filename%.*}"
            
            # Remove "main" prefix to get suffix (e.g., "d" or "")
            suffix="${base#main}"
            
            # Construct target jar name (e.g., "serverd.jar" or "server.jar")
            target="server${suffix}.jar"

            echo "Compiling $file -> $target"
            
            # Compile
            kotlinc "$file" -include-runtime -d "$target"

            if [ -f "$target" ]; then
              echo "Successfully built $target"
              BUILT_ANY=true
            else
              echo "Failed to build $target"
              exit 1
            fi
          done

          if [ "$BUILT_ANY" = false ]; then
             echo "ERROR: No jars were built."
             exit 1
          fi

      - name: Commit and push built jars
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add any file matching server*.jar in the root
          # This covers server.jar, serverd.jar, servert.jar, etc.
          git add server*.jar

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update jars from CI"
            git push origin HEAD:${GITHUB_REF_NAME}
          fi
