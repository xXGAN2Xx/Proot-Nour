name: Build and commit jars

on:
  push:
    paths:
      - '**/*.kt'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          check-latest: true

      - name: Build Jars
        shell: bash
        run: |
          set -eo pipefail
          mkdir -p build

          # Function to install Kotlin if missing
          ensure_kotlinc() {
            if ! command -v kotlinc >/dev/null 2>&1; then
              echo "kotlinc not found â€” installing kotlin via sdkman..."
              curl -sS https://get.sdkman.io | bash
              source "$HOME/.sdkman/bin/sdkman-init.sh"
              sdk install kotlin
            fi
          }

          # 1. Find and Compile maind.kt -> serverd.jar
          # We use 'find' to locate the file dynamically in case the path changed
          MAIND_SRC=$(find . -type f -name "maind.kt" | head -n 1)

          if [ -n "$MAIND_SRC" ]; then
            ensure_kotlinc
            echo "Found source: $MAIND_SRC"
            echo "Compiling $MAIND_SRC -> build/serverd.jar"
            
            kotlinc "$MAIND_SRC" -include-runtime -d build/serverd.jar
            
            if [ -f build/serverd.jar ]; then
              cp -f build/serverd.jar ./serverd.jar
              echo "SUCCESS: serverd.jar created."
            else
              echo "ERROR: Compilation failed for serverd.jar"
              exit 1
            fi
          else
            echo "WARNING: maind.kt was not found in the repository. Skipping serverd.jar."
          fi

          # 2. Find and Compile main.kt -> server.jar
          MAIN_SRC=$(find . -type f -name "main.kt" | head -n 1)

          if [ -n "$MAIN_SRC" ]; then
            ensure_kotlinc
            echo "Found source: $MAIN_SRC"
            echo "Compiling $MAIN_SRC -> build/server.jar"
            
            kotlinc "$MAIN_SRC" -include-runtime -d build/server.jar
            
            if [ -f build/server.jar ]; then
              cp -f build/server.jar ./server.jar
              echo "SUCCESS: server.jar created."
            else
              echo "ERROR: Compilation failed for server.jar"
              exit 1
            fi
          else
            echo "WARNING: main.kt was not found in the repository. Skipping server.jar."
          fi

          # Final verification
          if [ ! -f ./server.jar ] && [ ! -f ./serverd.jar ]; then
             echo "CRITICAL ERROR: Neither JAR file could be built. Please check repository file structure."
             exit 1
          fi

      - name: Commit and push
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Force add to ensure ignored files are included if necessary
          if [ -f server.jar ]; then
            git add -f server.jar
          fi

          if [ -f serverd.jar ]; then
            git add -f serverd.jar
          fi

          # Check status detailed
          git status

          if git diff --cached --quiet; then
            echo "No changes to commit (JARs are identical to previous version)."
          else
            git commit -m "Update server jars [skip ci]"
            git push origin HEAD:${GITHUB_REF_NAME}
          fi
