name: Build and commit jars

on:
  push:
    paths:
      - 'wrappers/Kotlin/**'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up JDK (Temurin, latest patch for chosen major)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          check-latest: true

      - name: Build server.jar and serverd.jar
        shell: bash
        run: |
          set -eo pipefail

          mkdir -p build

          # Function to install Kotlin if missing
          ensure_kotlinc() {
            if ! command -v kotlinc >/dev/null 2>&1; then
              echo "kotlinc not found â€” installing kotlin via sdkman..."
              curl -sS https://get.sdkman.io | bash
              source "$HOME/.sdkman/bin/sdkman-init.sh"
              sdk install kotlin
            fi
          }

          # --- Compile serverd.jar (from maind.kt) ---
          if [ -f "wrappers/Kotlin/maind.kt" ]; then
            ensure_kotlinc
            echo "Compiling wrappers/Kotlin/maind.kt -> build/serverd.jar"
            kotlinc wrappers/Kotlin/maind.kt -include-runtime -d build/serverd.jar
            
            if [ -f build/serverd.jar ]; then
              cp -f build/serverd.jar ./serverd.jar
              echo "serverd.jar copied to the root directory"
            else
              echo "Failed to create serverd.jar"
            fi
          else
            echo "wrappers/Kotlin/maind.kt not found, skipping serverd.jar build."
          fi

          # --- Compile server.jar (from main.kt) ---
          if [ -f "wrappers/Kotlin/main.kt" ]; then
            ensure_kotlinc
            echo "Compiling wrappers/Kotlin/main.kt -> build/server.jar"
            kotlinc wrappers/Kotlin/main.kt -include-runtime -d build/server.jar
            
            if [ -f build/server.jar ]; then
              cp -f build/server.jar ./server.jar
              echo "server.jar copied to the root directory"
            else
              echo "Failed to create server.jar"
            fi
          else
            echo "wrappers/Kotlin/main.kt not found, skipping server.jar build."
          fi

          # Optional: Fail if neither JAR exists in the root now
          if [ ! -f ./server.jar ] && [ ! -f ./serverd.jar ]; then
             echo "ERROR: Neither server.jar nor serverd.jar were built."
             exit 1
          fi

      - name: Commit and push built jars
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add server.jar if it exists
          if [ -f server.jar ]; then
            git add server.jar
          fi

          # Add serverd.jar if it exists
          if [ -f serverd.jar ]; then
            git add serverd.jar
          fi

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update jars from CI"
            git push origin HEAD:${GITHUB_REF_NAME}
          fi
