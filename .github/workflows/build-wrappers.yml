name: Build and upload server.jar

on:
  push:
    paths:
      - 'wrappers/**'
  pull_request:
    paths:
      - 'wrappers/**'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build:
    name: Compile Kotlin and upload server.jar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show wrappers folder contents
        run: |
          echo "PWD: $(pwd)"
          echo "== wrappers listing =="
          ls -la wrappers || true
          echo "======================"

      - name: Set up JDK (required for Kotlin/Gradle)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build (Gradle if present, else kotlinc via apt)
        id: build_step
        shell: bash
        run: |
          set -eo pipefail

          list_jars() {
            echo "=== Jar files found ==="
            find . -type f -name "*.jar" -print || true
            echo "=== end jars ==="
          }

          if [ -x "./gradlew" ]; then
            echo "Detected ./gradlew -> using Gradle to build"
            chmod +x ./gradlew
            # try assemble, fallback to build
            ./gradlew clean assemble || ./gradlew clean build
            list_jars
            exit 0
          fi

          echo "No gradlew found -> using kotlinc installed from apt"
          sudo apt-get update
          sudo apt-get install -y kotlin

          # locate Kotlin files under wrappers
          KT_FILES=$(find wrappers -type f -name "*.kt" -print | tr '\n' ' ')
          if [ -z "$KT_FILES" ]; then
            echo "No .kt files found under wrappers/ - nothing to compile"
            exit 1
          fi

          echo "Compiling Kotlin files: $KT_FILES"
          mkdir -p build
          kotlinc $KT_FILES -include-runtime -d build/server.jar

          if [ -f build/server.jar ]; then
            echo "Produced build/server.jar"
          else
            echo "build/server.jar not found after kotlinc; listing jars to help debug"
          fi

          list_jars

      - name: Confirm JAR presence (debug)
        run: |
          echo "Searching for server.jar and other jars:"
          find . -type f \( -name "server.jar" -o -path "*/build/libs/*.jar" -o -name "*.jar" \) -print || true

      - name: Upload server-jar artifact (globs)
        uses: actions/upload-artifact@v4
        with:
          name: server-jar
          path: |
            build/server.jar
            **/build/libs/*.jar
            **/server.jar
            **/*.jar
          retention-days: 7
